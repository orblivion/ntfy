{
	# Caddy by default supports https (and even handles ACME certs). For our
	# purposes this is annoying at best.
	auto_https off

	# The admin API would let you edit this config over http (!) at localhost:2019
	# Sandstorm presumably wouldn't allow outside requests to hit it but who knows.
	admin off
}

# Handling all IPs at this port. If I specify localhost, requests do show up in
# the logs (if I set it to log all requests below), but the page won't show up
# in the browser.
# TODO I don't know exactly why this is the case. I wonder if there's anything
#   unsafe here?
:8080 {
	log {
		output stdout
		format json
		level error # removing this line defaults to "info" which logs every request
	}

	# "Admin API" is not preceded by the API_ROOT, so it is accessible only
	# through the web root.
	handle_path {$ADMIN_ROOT} {
		# Connecting to the python service for now, but later may connect to the go service.
		# If we do that, we would need a way to stop these endpoints from being accessible below.
		reverse_proxy :8082 {
			# Retry for up to 5 seconds if the app hasn't started yet.
			lb_try_duration 5s

			# By default lb_try_interval is .250. To match 5 seconds we want 20 retries.
			lb_retries 20
		}
	}

	# "Client API" is preceded by the API_ROOT, so it can only access normal ntfy endpoints.
	handle_path {$API_ROOT}* {
		rewrite * {uri}
	}

	# If we get here, we're doing a request to normal ntfy endpoints, either via the web or
	# via the Client API.
	reverse_proxy :8081 {
		# Retry for up to 5 seconds if the app hasn't started yet.
		lb_try_duration 5s

		# By default lb_try_interval is .250. To match 5 seconds we want 20 retries.
		lb_retries 20
	}
}
